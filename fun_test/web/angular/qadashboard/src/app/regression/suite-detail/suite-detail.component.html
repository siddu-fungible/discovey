<div class="component">
  <div class="row">
    <div class="col">
      <div class="card">
        <div class="card-header">
          Suite info
          <span style="display: inline">
            <ng-template #suiteContent let-modal>
                <div class="card">
                  <div class="card-header">
                    Re-run options
                    <span *ngIf="reRunScript"> Script: {{ reRunScript }}</span>
                  </div>
                  <div class="card-body">
                    <div class="re-run-div">
                      <button (click)="toggleReRunOptions()" class="btn click-button"
                              [ngClass]="{'btn-primary': reRunOptionsReRunAll, 'btn-outline-primary': !reRunOptionsReRunAll}">
                        <i class="fa" [ngClass]="{'fa-check': reRunOptionsReRunAll}"></i> Re-run all
                      </button>
                    </div>
                    <div class="re-run-div">
                      <button (click)="toggleReRunOptions()" class="btn click-button"
                              [ngClass]="{'btn-primary': reRunOptionsReRunFailed, 'btn-outline-primary': !reRunOptionsReRunFailed}">
                        <i class="fa" [ngClass]="{'fa-check': reRunOptionsReRunFailed}"></i> Re-run failed
                      </button>
                    </div>
                    <div class="re-run-div" *ngIf="suiteExecution.fields.test_bed_type !== 'simulation'">
                      <button (click)="togglereUseBuildImage()" class="btn click-button"
                              [ngClass]="{'btn-primary': reUseBuildImage, 'btn-outline-primary': !reUseBuildImage}"><i
                        class="fa" [ngClass]="{'fa-check': reUseBuildImage}"></i>Re-use Jenkins build image
                      </button>
                      (From the original run)
                    </div>
                    <div>
                    </div>

                    <app-section-horizontal-line></app-section-horizontal-line>
                    <div style="display: flex; justify-content: flex-end">
                      <span class="pseudo-anchor" (click)="modal.dismiss('Cross click')">Cancel</span> &nbsp;&nbsp;
                      <button class="btn btn-success submit-button" (click)="modal.close(suiteExecution)">Submit
                      </button>
                    </div>
                  </div>

                </div>

              </ng-template>
            <span
              *ngIf="(suiteExecution?.fields.state !== stateMap.IN_PROGRESS) && (suiteExecution?.fields.state !== stateMap.ABORTED)"
              (click)="reRunModalOpen(suiteContent)"
              class="anchor-button pseudo-anchor">Re-run options
            </span>
          </span>



          <span *ngIf="suiteExecution?.fields.state > stateMap.COMPLETED" (click)="killClick(suiteExecution.fields.execution_id)"
            class="anchor-button pseudo-anchor">Kill
          </span>
        </div>
        <div class="card-body">
          <table class="">
            <tr *ngFor="let attribute of attributes">
              <td class="cell">
                <b>{{ attribute.name }}</b>
              </td>
              <ng-container [ngSwitch]="attribute.name">
                <td *ngSwitchCase="'Job state'">
                  <app-smart-label [value]="stateStringMap[attribute.value]"></app-smart-label>
                </td>
                <td *ngSwitchCase="'Result'">
                  <app-smart-label [value]="attribute.value"></app-smart-label>
                </td>
                <td *ngSwitchCase="'Path'">
                  <ng-container *ngIf="suiteExecution">
                    {{ suiteExecution.fields.suite_type === 'dynamic'? 'Re(' + getReRunOriginalSuitePath(suiteExecution) + ')' : suiteExecution.fields.suite_path }}
                  </ng-container>
                </td>
                <td *ngSwitchCase="'Completed Time'">
                  <ng-container *ngIf="suiteExecution && suiteExecution.fields.state <= stateMap.COMPLETED">
                    {{ attribute.name.includes(' Time')? localizeTime(attribute.value): attribute.value }}
                  </ng-container>
                </td>
                <td *ngSwitchCase="'Started Time'">
                  <ng-container
                    *ngIf="suiteExecution && suiteExecution.fields && (suiteExecution.fields.state == stateMap.IN_PROGRESS || suiteExecution.fields.state <= stateMap.COMPLETED)">
                    {{ attribute.name.includes(' Time')? localizeTime(attribute.value): attribute.value }}
                  </ng-container>
                </td>

                <td *ngSwitchDefault>
                  {{ attribute.name.includes(' Time')? localizeTime(attribute.value): attribute.value }}
                </td>
              </ng-container>


            </tr>
            <tr *ngIf="suiteExecution">
              <td><a href="{{ getSchedulerLog(suiteExecution.fields.execution_id) | async }}">Scheduler
                log</a></td>
            </tr>
            <tr *ngIf="suiteExecution">
              <td><a href="{{ getSchedulerLogDir(suiteExecution.fields.execution_id) | async }}">Log directory (Absolute path: {{ ABSOLUTE_LOG_DIRECTORY + suiteExecution.fields.execution_id }})</a>
            </tr>
            <tr *ngIf="environment">
              <td>Branch_FunOS</td>
              <td>{{ environment.BRANCH_FunOS }}</td>
            </tr>
            <tr *ngIf="environment">
              <td>RELEASE_BUILD</td>
              <td>{{ environment.RELEASE_BUILD }}</td>
            </tr>
            <tr
              *ngIf="suiteExecution && suiteExecution.fields.description && suiteExecution.fields.description.length > 0">
              <td>Description</td>
              <td>{{ suiteExecution.fields.description }}</td>
            </tr>
          </table>
          <ng-container *ngIf="suiteExecution">
            <div class="pseudo-anchor" (click)="showInputsClick(suiteExecution)">
              {{ suiteExecution.showingInputs? "Hide": "Show" }} inputs
            </div>
            <ng-container *ngIf="suiteExecution.showingInputs">
              <div><b>Inputs</b></div>
              <td *ngIf="(suiteExecution.parsedInputs | keyvalue)?.length">
                <ngx-json-viewer [json]="suiteExecution.parsedInputs" [expanded]="false"></ngx-json-viewer>
              </td>
            </ng-container>
          </ng-container>


          <ng-container *ngIf="suiteExecution">
            <div class="pseudo-anchor" (click)="showEnvironmentClick(suiteExecution)">
              {{ suiteExecution.showingEnvironment? "Hide": "Show" }} environment
            </div>
            <ng-container *ngIf="suiteExecution.showingEnvironment">
              <div><b>Environment</b></div>
              <td *ngIf="(suiteExecution.parsedEnvironment | keyvalue)?.length">
                <ngx-json-viewer [json]="suiteExecution.parsedEnvironment" [expanded]="false"></ngx-json-viewer>
              </td>
            </ng-container>
          </ng-container>
        </div>
      </div>


      <div *ngIf="suiteExecution" [innerHTML]="suiteExecution.fields.banner | safeHtml">
      </div>


      <div *ngIf="suiteExecution?.reRunInfo?.reRunInfo.length > 0">Re-run info:
        <span (click)="showDetailsClick(suiteExecution)" *ngIf="suiteExecution?.reRunInfo?.numActive"
              class="text-color-red">Active: <span
          class="pseudo-anchor">{{ suiteExecution?.reRunInfo?.numActive }}</span></span>
        <span (click)="showDetailsClick(suiteExecution)" *ngIf="suiteExecution?.reRunInfo?.numCompleted "
              class="text-color-green">Completed: <span
          class="pseudo-anchor">{{ suiteExecution?.reRunInfo?.numCompleted }}</span></span>
        <ng-container *ngIf="suiteExecution.fields.suite_type === 'dynamic'">
    <span (click)="showDetailsClick(suiteExecution)" *ngIf="suiteExecution?.reRunInfo?.reRunInfo.length > 0">
      <a href="/regression/suite_detail/{{ suiteExecution?.reRunInfo.reRunInfo[0].original.suite_execution_id }}">Original:
        {{ suiteExecution?.reRunInfo.reRunInfo[0].original.suite_execution_id }}</a>
    </span>
        </ng-container>
        <ng-container *ngIf="suiteExecution.showingDetails">
          <app-re-run-panel *ngIf="suiteExecution.reRunInfo" [reRunInfo]="suiteExecution.reRunInfo"></app-re-run-panel>
        </ng-container>
      </div>

      <ng-container *ngIf="suiteExecution?.fields.state == stateMap.QUEUED">
        <br>
        <span class="h6">Queue occupancy:</span>
        <app-queue-viewer></app-queue-viewer>
      </ng-container>


      <div class="card" *ngFor="let scriptExecutionInfo of scriptExecutionsMap | keyvalue">
        <div class="card card-primary">
          <div class="card-header"><b>Script: {{ scriptInfo[scriptExecutionInfo.key]?.script_path }} </b>
            <span
              *ngIf="(suiteExecution?.fields.state !== stateMap.IN_PROGRESS) && (suiteExecution?.fields.state !== stateMap.ABORTED)"
              (click)="reRunModalOpen(suiteContent, scriptExecutionInfo.key)"
              class="anchor-button pseudo-anchor">Re-run options
            </span>



            <ng-container *ngIf="scriptInfo.hasOwnProperty(scriptExecutionInfo.key)">
              <label class="badge badge-history pseudo-anchor" data-placement="top" data-toggle="tooltip"
                     title="history" (click)="clickHistory(scriptExecutionInfo.key)">history</label>
            </ng-container>
          </div>
          <div class="card-body">
            <jira-info *ngIf="scriptInfo[scriptExecutionInfo.key]?.id"
                       [apiUrl]="'/regression/jiras/' + scriptInfo[scriptExecutionInfo.key].id">
            </jira-info>


            <br>
            <table *ngIf="getKeys(scriptExecutionInfo.value).length > 0"
                   class="table table-hover table-responsive table-bordered">
              <thead>
              <tr>
                <th class="text-center">E Id</th>
                <th class="text-center">T Id</th>
                <th class="text-center">Summary</th>
                <th class="text-center">Inputs</th>
                <th class="text-center">Result</th>
                <th class="text-center">Scheduled At</th>
                <th class="text-center">HTML</th>
                <th class="text-center">Console</th>
                <th class="text-center">New report <span class="badge badge-warning">Beta</span></th>
                <!--th class="text-center">Action</th-->
              </tr>
              </thead>
              <tr *ngFor="let script of scriptExecutionInfo.value | keyvalue">
                <td>{{ script.value.execution_id }}</td>
                <td>{{ script.value.test_case_id }}</td>
                <td class="text-left">{{ script.value.test_case_id === 0? 'Script setup': script.value.summary }}</td>
                <td>{{ parseInputs(script.value.inputs)  }}</td>
                <td>
                  <ng-container *ngIf="hasReRuns(script.value); else NonReRunResult">
                    <div class="text-left">
                      <ul>
                        <li style="margin-bottom: unset">Latest-run:
                          <app-smart-label [value]="script.value.result" [type]="script.value.result"></app-smart-label>
                        </li>
                        <li style="margin-bottom: unset">Original:
                          <app-smart-label [value]="getOriginalResult(script.value)"
                                           [type]="getOriginalResult(script.value)"></app-smart-label>
                        </li>
                        <li><span style="text-align: unset" (click)="setReRunInfo(script.value)" class="pseudo-anchor">Re-run history</span>
                        </li>

                      </ul>
                    </div>

                  </ng-container>
                  <ng-template #NonReRunResult>
                    <app-smart-label [value]="script.value.result" [type]="script.value.result"></app-smart-label>
                  </ng-template>
                </td>
                <td>{{ localizeTime(script.value.started_time) }}</td>
                <td>
                  <ng-container *ngIf="hasReRuns(script.value); else NonReRunHtml">
                    <ul>
                      <li>Latest: <span class="pseudo-anchor"
                                        (click)="getHtmlLogPath(getLatestRerunSuiteExecutionId(script.value), script.value.script_path, testCaseInfo[getLatestRerunEntry(script.value).re_run_test_case_execution_id].log_prefix)">HTML</span>
                      </li>
                      <li>Original: <span class="pseudo-anchor"
                                          (click)="getHtmlLogPath(suiteExecutionId, script.value.script_path, script.value.log_prefix)">HTML</span>
                    </ul>
                  </ng-container>
                  <ng-template #NonReRunHtml>
                    <span class="pseudo-anchor"
                          (click)="getHtmlLogPath(suiteExecutionId, script.value.script_path, script.value.log_prefix)">HTML</span>
                  </ng-template>
                </td>
                <td>
                  <ng-container *ngIf="hasReRuns(script.value); else NonReRunConsole">
                    <ul>
                      <li>Latest: <span class="pseudo-anchor"
                                        (click)="getConsoleLogPath(getLatestRerunSuiteExecutionId(script.value), script.value.script_path, testCaseInfo[getLatestRerunEntry(script.value).re_run_test_case_execution_id].log_prefix)">Console</span>
                      </li>
                      <li>Original: <span class="pseudo-anchor"
                                          (click)="getConsoleLogPath(suiteExecutionId, script.value.script_path, script.value.log_prefix)">Console</span>
                    </ul>
                  </ng-container>
                  <ng-template #NonReRunConsole>
                    <span class="pseudo-anchor"
                          (click)="getConsoleLogPath(suiteExecutionId, script.value.script_path, script.value.log_prefix)">Console</span>

                  </ng-template>
                </td>
                <td>
                  <a [routerLink]="[getScriptDetailLink(scriptExecutionInfo.key, script.value.execution_id, script.value.log_prefix)]">New report</a>
                </td>
                <!--td>
									<button data-placement="top" data-toggle="tooltip" title="Re-run"
													(click)="rerunClick(executionId, script.value.test_case_id, script.value.script_path)"
													class="btn btn-outline-warning btn-sm">
										<i class="fa fa-refresh"></i></button>
								</td-->
              </tr>

            </table>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="showReRunPanel" class="col">
      <div id="re-run-panel" class="card">
        <div class="card-header">
          Re-run history: <b>{{ currenReRunScriptInfo.script_path }}</b> Test-case
          ID: {{ currenReRunScriptInfo.test_case_id }}
          <span class="float-sm-right pseudo-anchor" (click)="showReRunPanel = false">Close</span>

        </div>
        <div class="card-body">
          <table class="table-nonfluid table">
            <tr class="text-center">
              <th>
                Original result
              </th>
              <th>
                Re-run result
              </th>
              <th>
                Suite ID
              </th>
              <th>
                TC execution ID
              </th>
              <th>
                Started at
              </th>
              <th>
                HTML
              </th>
              <th>
                Console
              </th>
            </tr>
            <tr *ngFor="let reRun of currenReRunHistory">
              <td>
                <app-smart-label [value]="reRun.result" [type]="reRun.result"></app-smart-label>
              </td>
              <td>
                {{ reRun.re_run_result }}
              </td>
              <td>
                <a href="/regression/suite_detail/{{ reRun.re_run_suite_execution_id }}">{{ reRun.re_run_suite_execution_id }}</a>
              </td>
              <td>
                {{ reRun.re_run_test_case_execution_id }}
              </td>
              <td>
                {{ localizeTime(reRun.started_time) }}
              </td>
              <td *ngIf="testCaseInfo.hasOwnProperty(reRun.re_run_test_case_execution_id)">
                <span class="pseudo-anchor"
                      (click)="getHtmlLogPath(reRun.re_run_suite_execution_id, currenReRunScriptInfo.script_path, testCaseInfo[reRun.re_run_test_case_execution_id].log_prefix)">HTML</span>
              </td>
              <td *ngIf="testCaseInfo.hasOwnProperty(reRun.re_run_test_case_execution_id)">
                <span class="pseudo-anchor"
                      (click)="getConsoleLogPath(reRun.re_run_suite_execution_id, currenReRunScriptInfo.script_path, testCaseInfo[reRun.re_run_test_case_execution_id].log_prefix)">Console</span>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
