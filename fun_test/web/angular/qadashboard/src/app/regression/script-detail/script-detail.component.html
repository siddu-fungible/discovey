<div class="fun-flex-container fun-action-nav">
  <span class="script-name">{{ scriptPath }}</span>
  <div class="fun-spacer"></div>
  <button class="fun-button-with-icon" (click)="routeToMenu('show_context')"><i class="fa fa-columns"></i>&nbsp;Context
    options
  </button>
  <button class="fun-button-with-icon" [ngClass]="{'fun-button-with-icon-selected': sidePanelOpen}"
          (click)="routeToMenu('show_charts')"><i class="fa fa-bar-chart"></i>&nbsp;Select
    charts
  </button>
  <button class="fun-button-with-icon" (click)="openConsoleLogClick()"><i
    class="fa fa-file-text-o"></i>&nbsp;Console
    log
  </button>
  <button class="fun-button-with-icon" [ngClass]="{'fun-button-with-icon-selected': showingArtifactPanel}"
          (click)="routeBasedOnBoolean(showingArtifactPanel, 'show_more_logs')"><i class="fa fa-files-o"></i>&nbsp;More
    logs
  </button>
  <button class="fun-button-with-icon" [ngClass]="{'fun-button-with-icon-selected': showingTablesPanel}"
          (click)="routeBasedOnBoolean(showingTablesPanel, 'show_tables')"><i class="fa fa-table"></i> Show tables
  </button>
  <!--button (click)="testClick()">Test</button-->
  <ng-template #contextOptions let-modal>
    <div class="fun-panel">
      <div class="fun-panel-header">
        <span>Select contexts to display</span>
      </div>
      <div class="fun-panel-body">
        <ng-container *ngFor="let availableContext of availableContexts">
          <div>
            <input type="checkbox" [(ngModel)]="availableContext.selected" [checked]="availableContext?.selected">
            <span
              class="checkbox-text">ID : {{ availableContext.context_id }} ({{ availableContext.description }})</span>
          </div>
        </ng-container>
      </div>
    </div>
  </ng-template>
  <ng-template #chartSelectionOptions let-modal>
    <div class="fun-panel">
      <div class="fun-panel-header">
        Select charts
      </div>
      <div class="fun-panel-body">
        <div class="fun-flex-container">
          <div class="fun-flex-item">
            Select category<select [(ngModel)]="selectedStatisticsCategory">
            <option [ngValue]="statisticsCategory" *ngFor="let statisticsCategory of statisticsCategories">
              {{ statisticsCategory.display_name }}
            </option>
          </select>
          </div>
          <ng-container *ngIf="selectedStatisticsCategory">
            <div class="fun-flex-item">
              Select sub-category<select [(ngModel)]="selectedStatisticsSubCategory">
              <option [ngValue]="statisticsSubCategory"
                      *ngFor="let statisticsSubCategory of selectedStatisticsCategory?.sub_categories;">
                {{ statisticsSubCategory.display_name }}
              </option>
            </select>
            </div>
          </ng-container>
          <span (click)="addStatisticsCategory()" *ngIf="selectedStatisticsSubCategory" class="pseudo-anchor">Add</span>
        </div>

        <table class="fun-table" *ngIf="selectedStatistics?.length > 0">
          <tr>
            <td class="fun-table-header">Category</td>
            <td class="fun-table-header">Sub-category</td>
            <td class="fun-table-header"></td>
          </tr>
          <tr *ngFor="let selectedStatistic of selectedStatistics; let index=index">
            <td>{{ selectedStatistic.statisticsCategory.display_name }}</td>
            <td>{{ selectedStatistic.statisticsSubCategory.display_name }}</td>
            <td><i (click)="deleteSelectedStatisticClick(index)" class="fa fa-trash-o"
                   style="font-size:20px; color: red"></i>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </ng-template>
</div>

<div class="side-panel" [ngClass]="{'side-panel-open': sidePanelOpen}">
  <div style="margin: 10px">
    <div style="display: flex; align-items: flex-end; flex-direction: column">
    <div class="fun-cancel-link" (click)="viewChartsClick()">Close</div>
  </div>
  <div class="fun-flex-container">
    <div class="fun-flex-item">
      <label style="font-weight: bold">Available charts:</label>
      <app-tree [tree]="tree" (clickedStatsTreeNode)="clickedStatsTreeNode($event)"></app-tree>
    </div>
    <div class="fun-flex-item">
      <label style="font-weight: bold">Selected charts:</label><br>
      <span class="selected-option" *ngFor="let stat of selectedStatsSet">
      {{stat.name}}&nbsp;<span  style="cursor: pointer" (click)="deSelectStats(stat)">x</span>
      </span>
    </div>
  </div>
  <br>
    <span class="fun-button-add" (click)="setStatistics()">Apply</span>
  </div>
</div>
<!--app-timeline-control *ngIf="showLogsPanel" [domainMin]="minRelativeTime" [domainMax]="maxRelativeTime" [title]="'Show logs starting from'" [unit]="'s'" (valueChanged)="onTimeLineChanged($event)"></app-timeline-control-->
<div class="" style="overflow: auto; height: 100%; width: 100%;">
  <div *ngIf="showingArtifactPanel" [@show]="showingArtifactPanel" style="padding: 10px">
    <app-section-header [title]="'Artifacts'"></app-section-header>
    <div class="fun-panel-body">
      <div style="padding: 10px">
        <span>Filters:</span>
        <span class="fun-attribute-label">Asset type:</span>
        <select [(ngModel)]="artifactFilter.assetType">
          <option [ngValue]="null">-- ALL --</option>
          <option *ngFor="let availableAssetType of artifactTree.availableAssetTypes" [ngValue]="availableAssetType">
            {{ availableAssetType }}
          </option>
        </select>

        <span class="fun-attribute-label">Asset</span>
        <select [(ngModel)]="artifactFilter.assetId">
          <option [ngValue]="null">-- ALL --</option>
          <option *ngFor="let availableAssetId of artifactTree.availableAssetIds" [ngValue]="availableAssetId">
            {{ availableAssetId }}
          </option>
        </select>
      </div>


      <table class="fun-table">
        <tr>
          <td class="fun-table-header">Asset type</td>
          <td class="fun-table-header">Asset</td>
          <td class="fun-table-header">Category</td>
          <td class="fun-table-header">Sub-category</td>
          <td class="fun-table-header">Link</td>
        </tr>
        <ng-container *ngFor="let assetType of artifactTree.root | keyvalue">
          <ng-container *ngFor="let assetId of assetType.value | keyvalue">
            <ng-container *ngFor="let category of assetId.value | keyvalue">
              <ng-container *ngIf="!artifactFilter.assetType || (artifactFilter.assetType === assetType.key)">
                <ng-container *ngIf="!artifactFilter.assetId || (artifactFilter.assetId === assetId.key)">
                  <tr *ngFor="let record of category.value">
                    <td>{{ record.data.asset_type }}</td>
                    <td>{{ record.data.asset_id }}</td>
                    <td>{{ record.data.category }}</td>
                    <td>{{ record.data.sub_category }}</td>
                    <td><a href="{{ record.data.link }}">{{ record.data.description }}</a></td>
                  </tr>
                </ng-container>
              </ng-container>

            </ng-container>
          </ng-container>
        </ng-container>
      </table>
    </div>
  </div>
  <app-section-horizontal-line></app-section-horizontal-line>
  <div *ngIf="showingTablesPanel" class="fun-panel panel" [@show]="showingTablesPanel">
    <div *ngFor="let testCaseTablePanel of testCaseTablePanels | keyvalue" class="fun-panel">
      <div class="fun-panel-header">
        {{ testCaseTablePanel.key }}
      </div>
      <div *ngFor="let testCaseTable of testCaseTablePanel.value" class="fun-panel-body">
        <div class="fun-panel">
          <div class="fun-panel-header">
            {{ testCaseTable.data.table_name }}
          </div>
          <div class="fun-panel-body">
            <table class="fun-table">
              <tr>
                <td class="fun-table-header"
                    *ngFor="let header of testCaseTable.data.table_data.headers">{{ header }}
                </td>
              </tr>
              <tr *ngFor="let row of testCaseTable.data.table_data.rows">
                <td *ngFor="let rowElement of row">{{ rowElement }}</td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>


  </div>

  <div class="fun-flex-container" style="align-items: flex-start;">
    <div *ngIf="showTestCasePanel" class="fun-flex-item panel fun-panel" [@show]="showTestCasePanel">
      <div class="fun-panel-header">
        <span class="fun-panel-header-main-text">Test-cases</span>
        <label style="margin: auto 20px auto">
          <input type="checkbox" [(ngModel)]="showFailedTestCases" [checked]="showFailedTestCases"/> Show failed
        </label>

      </div>
      <div class="fun-panel-body auto-scroll test-case-panel">
        <table class="fun-table">
          <tr>
            <td class="fun-table-header">ID</td>
            <td class="fun-table-header">Description</td>
            <td class="fun-table-header">Result</td>
          </tr>
          <tr *ngFor="let testCaseExecution of testCaseExecutions; let index=index"
              [ngClass]="{'selected-row': currentTestCaseExecution?.test_case_id === testCaseExecution.test_case_id }">

            <ng-container
              *ngIf="(!showFailedTestCases || (showFailedTestCases && (testCaseExecution.result === 'FAILED'))) && (testCaseExecution.result !== 'NOT_RUN')">
              <td>
                  <span [ngClass]="{'pseudo-anchor': testCaseExecution.result !== 'NOT_RUN'}"
                        (click)="onTestCaseIdClick(index, testCaseExecution.execution_id)">{{ testCaseExecution.test_case_id }}
                  </span>
              </td>
              <td>{{ testCaseExecution.summary }}</td>
              <td><span
                [ngClass]="{'passed': testCaseExecution.result === 'PASSED', 'failed': testCaseExecution.result === 'FAILED' }">{{ testCaseExecution.result }}</span>
              </td>

            </ng-container>

          </tr>
        </table>
      </div>
    </div>
    <div *ngIf="currentTestCaseExecution" class="fun-flex-item panel fun-panel" [@show]="showCheckpointPanel">
      <fun-spinner [status]="checkpointPanelStatus"></fun-spinner>
      <div class="fun-panel-header fun-flex-item fun-flex-container">
        <span class="fun-panel-header-main-text">Checkpoints</span>
        <label style="margin: auto 20px auto">
          <input type="checkbox" [(ngModel)]="showFailedCheckpoints" [checked]="showFailedCheckpoints"/> Show failed
        </label>
        <span *ngIf="!showTestCasePanel" (click)="onShowTestCasePanelClick()"
              class="pseudo-anchor">< Show test-cases</span>
      </div>
      <div *ngIf="!checkpointPanelStatus" class="fun-panel-body checkpoint-panel auto-scroll">
        <table class="fun-table">
          <tr>
            <td class="fun-table-header">Time</td>
            <td class="fun-table-header">ID</td>
            <td class="fun-table-header">Ctx</td>
            <td class="fun-table-header">Checkpoint</td>
            <td class="fun-table-header">Result</td>
            <td class="fun-table-header">Expected</td>
            <td class="fun-table-header">Actual</td>
          </tr>
          <tr *ngFor="let checkpoint of currentTestCaseExecution?.checkpoints"
              [ngClass]="{'selected-checkpoint-row': currentCheckpointIndex === checkpoint?.data?.checkpoint_index }">

            <ng-container
              *ngIf="!showFailedCheckpoints || (showFailedCheckpoints && checkpoint.data.result === 'FAILED')">
              <td>
                {{ checkpoint.relative_epoch_time | number: '1.3-3' }}
              </td>
              <td nowrap *ngIf="checkpoint.data.checkpoint != 'Start'" align="center">
                  <span class="fun-action-link" style="display: inline-block"
                        (click)="onCheckpointClick(currentTestCaseExecution, checkpoint.data.checkpoint_index, checkpoint.data.context_id)">{{ checkpoint.data.checkpoint_index }}
                  </span>
                &nbsp;
                <i tooltip [tooltipContentString]="'Logs are not downloaded yet'" placement="right"
                   (click)="onCheckpointClick(currentTestCaseExecution, checkpoint.data.checkpoint_index, checkpoint.data.context_id)"
                   class="fa fa-download" *ngIf="!checkpoint?.timeSeries"></i>
              </td>
              <td>{{ checkpoint.data.context_id }}</td>
              <td>{{ checkpoint.data.checkpoint }}</td>
              <td><span
                [ngClass]="{'passed': checkpoint.data.result === 'PASSED', 'failed': checkpoint.data.result === 'FAILED' }">{{ checkpoint.data.result }}</span>
              </td>
              <td>{{ checkpoint.data.expected }}</td>
              <td>{{ checkpoint.data.actual }}</td>


            </ng-container>

          </tr>
        </table>
      </div>
    </div>
    <div *ngIf="showLogsPanel" class="fun-flex-container fun-flex-item" id="logs-panel">
      <ng-container *ngFor="let availableContext of (availableContexts | selected )">
        <div class="fun-flex-item panel fun-panel">
          <div class="fun-panel-header">
            Context: {{ availableContext.context_id }} {{ availableContext.description }}
          </div>
          <div class="fun-panel-body">
            <h4>{{ currentTestCaseExecution.test_case_id }}: {{ currentTestCaseExecution.summary }}</h4>
            <fun-spinner [status]="status"></fun-spinner>
            <div [@show]="showLogsPanel" *ngIf="currentTestCaseExecution" class=" logs-panel auto-scroll">
              <div>
                <ng-container>
                  <ng-container *ngIf="logsAreTruncated">
                    <div class="pseudo-anchor" (click)="showPreviousLogsClick()">Show previous logs</div>
                    <br>
                  </ng-container>
                  <table>
                    <ng-container *ngFor="let checkpoint of currentTestCaseExecution?.checkpoints">
                      <tr *ngFor="let seriesElement of checkpoint?.timeSeries">
                        <ng-container
                          *ngIf="(seriesElement.data.context_id === availableContext.context_id) && (seriesElement.relative_epoch_time >= timeFilterMin)">
                          <ng-container
                            *ngIf="seriesElement.type === 80 && (seriesElement.data.checkpoint_index <= currentCheckpointIndex)">

                            <td class="timestamp" nowrap>
                              <small>{{ seriesElement.relative_epoch_time | number: '1.3-3' }}</small>
                            </td>
                            <td>
                              <div
                                id="{{ currentTestCaseExecution.test_case_id }}_{{ seriesElement.data?.checkpoint_index }}_{{ seriesElement.data?.context_id }}">
                                  <span class="checkpoint-span">Checkpoint: <app-smart-label
                                    [value]="seriesElement.data.result"></app-smart-label>&nbsp;{{ seriesElement.data?.checkpoint }}
                                  </span>
                              </div>
                            </td>
                          </ng-container>
                          <ng-container
                            *ngIf="seriesElement.type === 60 && (seriesElement.data.checkpoint_index <= currentCheckpointIndex + 1)">
                            <td class="timestamp" nowrap>
                              <small>{{ seriesElement.relative_epoch_time | number: '1.3-3' }}</small>
                            </td>
                            <td>
                              <pre style="margin: 0">{{ seriesElement.data?.log }}</pre>
                            </td>
                          </ng-container>
                        </ng-container>
                      </tr>
                    </ng-container>
                  </table>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
  <app-statistics-container [statistics]="selectedStatistics" [scriptExecutionInfo]="scriptExecutionInfo"
                            *ngIf="selectedStatistics?.length > 0"></app-statistics-container>

</div>





