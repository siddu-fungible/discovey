namespace eval ::sth {

}

proc ::sth::alarms_control {args} {
    
    variable ::sth::alarms::sortedSwitchPriorityList
    array unset ::sth::alarms::userArgsArray
    array set ::sth::alarms::userArgsArray {}
    variable ::sth::alarms::alarms_subscription_state
    
    set returnKeyedList ""

    set retVal [catch {
        ::sth::sthCore::Tracker "::sth::alarms_control" $args
        
        if {[catch {::sth::sthCore::commandInit \
            ::sth::alarms::alarmsTable \
            $args \
            ::sth::alarms:: \
            alarms_control \
            ::sth::alarms::userArgsArray \
            sortedSwitchPriorityList} eMsg]} {
                ::sth::sthCore::processError returnKeyedList "::sth::sthCore::commandInit error. Error: $eMsg" {}
                return $returnKeyedList                         
        }
        
        
        if {![info exists ::sth::alarms::userArgsArray(port_handle)]} {
            ::sth::sthCore::processError returnKeyedList "Error: Missing a mandatory attribute -port_handle." {}
            return $returnKeyedList
        }
        set portHandle $::sth::alarms::userArgsArray(port_handle)
        
        if {$::sth::alarms::alarms_subscription_state == 0} {
            set resultDataSet [::sth::sthCore::invoke stc::create "ResultDataSet" -under $::sth::GBLHNDMAP(project)]
            
            set resultQuery1 [::sth::sthCore::invoke stc::create "ResultQuery" -under $resultDataSet "-ResultRootList $::sth::GBLHNDMAP(project) -ConfigClassId port -ResultClassId SonetAlarmsResults"]
            set resultQuery2 [::sth::sthCore::invoke stc::create "ResultQuery" -under $resultDataSet "-ResultRootList $::sth::GBLHNDMAP(project) -ConfigClassId port -ResultClassId SonetResults"]
            
        }
    
        set state $::sth::alarms::userArgsArray(state)
        
        if {$state == 1} {
            set state "start"
        } else {
            set state "stop"
        }
        
        if {[info exist ::sth::alarms::userArgsArray(reset)] && $::sth::alarms::userArgsArray(reset) == 1} {
            set state "reset"
        }

        
        if {[catch {::sth::alarms::alarms_control_$state returnKeyedList} err]} {
            ::sth::sthCore::processError returnKeyedList "Failed in control sonet alarms :$err" {}
            return -code error $returnKeyedList
        }
        
        if {[catch {::sth::sthCore::doStcApply} applyStatus]} {
            ::sth::sthCore::processError returnKeyedList "::sth::sthCore::doStcApply Failed: Error while applying configuration: $applyStatus" {}
            return $returnKeyedList
        }
        
        if {$::sth::alarms::alarms_subscription_state == 0} {
        # Subscribe to the datasets
            ::sth::sthCore::invoke stc::perform ResultDataSetSubscribe -ResultDataSet $resultDataSet
            set ::sth::alarms::alarms_subscription_state 1
        }

    } returnedString]

    if {$retVal} {
        ::sth::sthCore::processError returnKeyedList $returnedString {}
    } else {
        keylset returnKeyedList status $::sth::sthCore::SUCCESS
    }
    return $returnKeyedList
}

proc ::sth::alarms_stats {args} {
    variable ::sth::alarms::sortedSwitchPriorityList
    array unset ::sth::alarms::userArgsArray
    array set ::sth::alarms::userArgsArray {}
    
    set returnKeyedList ""
    
    set retVal [catch {
        ::sth::sthCore::Tracker "::sth::alarms_stats" $args
        
        if {[catch {::sth::sthCore::commandInit \
            ::sth::alarms::alarmsTable \
            $args \
            ::sth::alarms:: \
            alarms_stats \
            ::sth::alarms::userArgsArray \
            sortedSwitchPriorityList} eMsg]} {
                ::sth::sthCore::processError returnKeyedList "::sth::sthCore::commandInit error. Error: $eMsg" {}
                return $returnKeyedList                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        }
        
        if {![info exists ::sth::alarms::userArgsArray(port_handle)]} {
            ::sth::sthCore::processError returnKeyedList "Error: Missing a mandatory attribute -port_handle." {}
            return $returnKeyedList
        }
        
        if {[catch {::sth::alarms::alarms_stats_collect returnKeyedList} err]} {
            ::sth::sthCore::processError returnKeyedList "Failed in control sonet alarms :$err" {}
            return -code error $returnKeyedList
        }
        
    } returnedString]

    if {$retVal} {
        ::sth::sthCore::processError returnKeyedList $returnedString {}
    } else {
        keylset returnKeyedList status $::sth::sthCore::SUCCESS
    }
    return $returnKeyedList
    
}
